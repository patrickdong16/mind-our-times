# Mind Our Times — 测试规范

> **版本**：v1.0  
> **日期**：2026-02-04  
> **对应需求**：REQUIREMENTS.md v1.0  
> **对应架构**：TDD.md v1.0

---

## 一、测试分层

| 层级 | 覆盖范围 | 工具 | 执行时机 |
|------|----------|------|----------|
| **单元测试** | 云函数逻辑、数据验证 | Node.js assert / Jest | 代码变更时 |
| **集成测试** | API 端到端、数据库读写 | curl + 脚本 | 部署后 |
| **视觉测试** | Webapp UI、响应式、暗色模式 | 浏览器截图验证 | UI 变更时 |
| **端到端测试** | Pepper → API → Webapp 全链路 | 脚本模拟 | 每个 Phase 交付前 |

---

## 二、Phase 1 测试清单

### 2.1 云函数：articles-write

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| W-01 | 正常写入 10 篇 | 完整 10 篇数据 + 有效 API Key | `{ success: true, inserted: 10 }` | curl POST + 检查响应 |
| W-02 | 缺少 API Key | 无 x-api-key 头 | `{ success: false, error: "Unauthorized" }`, HTTP 401 | curl POST |
| W-03 | 错误 API Key | 无效 key | HTTP 401 | curl POST |
| W-04 | 缺少必填字段 | 某条缺少 title | `{ success: false, error: "..." }`, HTTP 400 | curl POST |
| W-05 | 空 articles 数组 | `{ date: "...", articles: [] }` | HTTP 400, 明确错误信息 | curl POST |
| W-06 | 重复写入（幂等） | 同一日期写入两次 | 第二次覆盖，不产生重复 | 写入两次 → 读取验证数量 |
| W-07 | 字数不足 | content 少于 100 字 | 拒绝或警告 | curl POST |
| W-08 | 无效领域标识 | domain: "X"（不存在） | HTTP 400 | curl POST |

### 2.2 云函数：articles-read

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| R-01 | 获取今日文章 | `?action=today` | 返回今日全部文章 + 领域配置 | curl GET |
| R-02 | 今日无数据 | 当天没有写入 | `{ articles: [], total: 0 }` | curl GET |
| R-03 | 获取往期文章 | `?action=archive&page=1` | 分页返回，按日期倒序 | curl GET |
| R-04 | 领域筛选 | `?action=archive&domain=T` | 只返回技术领域文章 | curl GET |
| R-05 | 获取领域配置 | `?action=domains` | 返回 6 个领域定义 | curl GET |
| R-06 | 分页边界 | `?action=archive&page=999` | 空数组，不报错 | curl GET |
| R-07 | 无效参数 | `?action=invalid` | HTTP 400, 明确错误信息 | curl GET |

### 2.3 Webapp

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| U-01 | 今日 Tab 加载 | 浏览器打开，截图 | 显示当日全部文章，领域标签可见 |
| U-02 | 领域标签筛选 | 点击「技术」标签，截图 | 只显示技术领域文章 |
| U-03 | 往期 Tab | 切换到往期，截图 | 按日期分组显示，默认折叠 |
| U-04 | 往期展开 | 点击某日展开，截图 | 显示该日文章列表 |
| U-05 | 移动端适配 | Chrome DevTools 375px，截图 | 布局正确，文字可读，无横向溢出 |
| U-06 | 暗色模式 | 切换系统暗色模式，截图 | 配色切换，文字清晰可读 |
| U-07 | 原文链接 | 点击原文链接 | 新标签页打开真实 URL |
| U-08 | 空数据状态 | 后端无数据时 | 显示友好空状态提示，不白屏 |
| U-09 | API 加载失败 | 断开 API 连接 | 显示错误提示，不白屏 |
| U-10 | 首屏性能 | Lighthouse 审计 | Performance > 90 |

### 2.4 Pepper 脚本

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| P-01 | 生成 10 篇文章 | 运行脚本，检查输出 | 10 篇，每篇 300-400 字，有 6 个领域 |
| P-02 | 写入 CloudBase | 脚本执行完成后 API 查询 | 数据已入库，字段完整 |
| P-03 | Telegram 通知 | 检查 Telegram 消息 | 收到通知，含 webapp 链接 |
| P-04 | 重复执行（幂等） | 同一天运行两次 | 数据覆盖，不重复 |
| P-05 | RSS 源故障 | 模拟部分 RSS 不可达 | 不崩溃，用可用源凑足内容 |

### 2.5 端到端（E2E）

| 编号 | 测试场景 | 步骤 | 通过标准 |
|------|----------|------|----------|
| E-01 | 完整日更流程 | Pepper 生成 → 写入 API → Webapp 展示 | 全链路通畅，内容一致 |
| E-02 | 从零启动 | 空数据库 → 首次写入 → 首次访问 | Webapp 正常展示，无报错 |
| E-03 | 跨日累积 | 连续两天数据 → 往期页 | 两天数据都在，按日期排列 |

---

## 三、Phase 2 测试清单（公众号 + 投票）

### 3.1 综述生成

| 编号 | 测试场景 | 通过标准 |
|------|----------|----------|
| D-01 | 从 10 篇生成综述 | 1500-2500 字，引用 2-3 个主题 |
| D-02 | 投票问题生成 | 映射到有效领域，是/否标签匹配 |
| D-03 | 公众号草稿创建 | 微信后台可见草稿 |

### 3.2 H5 投票

| 编号 | 测试场景 | 通过标准 |
|------|----------|----------|
| V-01 | 投票提交 | 点击后写入数据库，显示结果 |
| V-02 | 防重复投票 | 同一 voter_id 再次投票被拒绝 |
| V-03 | 结果实时更新 | 投票后百分比正确计算 |
| V-04 | 趋势查询 | 90 天趋势数据正确返回 |

---

## 四、测试执行规范

### 4.1 自测流程（每次代码变更后）

```
1. 运行受影响的单元测试
2. curl 测试受影响的 API 端点
3. 浏览器打开 webapp 验证 UI
4. 移动端视口截图验证
5. 暗色模式截图验证（如涉及 UI 变更）
```

### 4.2 交付前流程（每个 Phase 完成时）

```
1. 跑完整测试清单（Phase 对应的全部编号）
2. 每个测试记录：通过/失败 + 证据（截图/curl 输出）
3. 失败项修复后重新验证
4. 全部通过后才向 DQ 报告「完成」
```

### 4.3 回归测试

- 任何 bug 修复必须增加对应测试用例
- 修复后验证：先确认修复前失败（红），再确认修复后通过（绿）

### 4.4 验证纪律（引用 GEMINI.md verification-before-completion）

> **不验证不能声称完成。**
>
> 任何「完成」「修复」「通过」的声明，必须附带：
> 1. 执行的验证命令
> 2. 实际输出/截图
> 3. 输出与期望的对比
>
> 「应该能行」≠ 验证证据。

---

## 五、测试数据

### 5.1 领域测试数据

```json
[
  {"id": "T", "name": "技术", "core_question": "AI 是否正在加剧社会分层？"},
  {"id": "P", "name": "政治", "core_question": "民主制度是否正在失效？"},
  {"id": "H", "name": "历史", "core_question": "当前文明是否正在走向衰退？"},
  {"id": "Φ", "name": "哲学", "core_question": "算法优化是否正在侵蚀自由意志？"},
  {"id": "R", "name": "宗教", "core_question": "科技是否正在成为新宗教？"},
  {"id": "F", "name": "金融", "core_question": "金融是否正在加剧社会撕裂？"}
]
```

### 5.2 文章测试数据

至少准备 10 条完整的测试文章数据，覆盖：
- 6 个领域各至少 1 条
- 含中英文混合内容
- 含特殊字符（引号、破折号、em dash）
- source_url 为真实可访问链接

### 5.3 边界测试数据

- 最短合法文章（300 字）
- 最长合法文章（400 字）
- 超长标题（100 字）
- 含 emoji 的标题
- 含 HTML 标签的 content（应被转义）

---

## 六、已知风险与缓解

| 风险 | 影响 | 缓解 |
|------|------|------|
| CloudBase 云函数冷启动慢 | 首次请求 > 2s | 设置保活策略或接受 |
| 国内网络波动 | API 偶尔超时 | 前端加 loading 状态 + 重试 |
| RSS 源批量不可达 | 当日内容不足 10 篇 | 脚本容错 + 降级提示 |
| Twikoo 评论被滥用 | 垃圾评论 | Akismet 反垃圾 + DQ 审核 |

---

*本文件定义 Mind Our Times 的测试策略和通过标准。*  
*所有测试必须在声称完成前执行并记录证据。*
