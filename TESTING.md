# Mind Our Times — 测试规范

> **版本**：v1.8  
> **日期**：2026-02-07  
> **对应需求**：REQUIREMENTS.md v1.8  
> **对应架构**：TDD.md v1.8

### 更新日志

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.8 | 2026-02-07 | cron 使用 mot-full-workflow.py 验证；H5 投票测试标记废弃 |
| v1.7 | 2026-02-07 | **防退步**：新增作者验证回归测试（AV-01~05）、质检禁用词扩充验证 |
| v1.6 | 2026-02-06 | **首发验证完成**：投票系统端到端测试、公众号草稿创建测试、阅读原文跳转测试 |
| v1.5 | 2026-02-06 | 投票问题质量测试（轻松有趣验证）、周五播客日验证（确认无RSS内容生成） |
| v1.4 | 2026-02-06 | 投票系统测试（H5页面+云函数+防重复）、选题结构化测试 |
| v1.3 | 2026-02-06 | 短分析格式固化测试、thumbnail 抓取测试、图文卡片测试 |
| v1.2 | 2026-02-06 | 播客内容格式测试、自动刷新测试、intro/双语金句验证 |
| v1.1 | 2026-02-05 | 播客日功能测试 |
| v1.0 | 2026-02-04 | 初版 |

---

## 一、测试分层

| 层级 | 覆盖范围 | 工具 | 执行时机 |
|------|----------|------|----------|
| **单元测试** | 云函数逻辑、数据验证 | Node.js assert / Jest | 代码变更时 |
| **集成测试** | API 端到端、数据库读写 | curl + 脚本 | 部署后 |
| **视觉测试** | Webapp UI、响应式、暗色模式 | 浏览器截图验证 | UI 变更时 |
| **端到端测试** | Pepper → API → Webapp 全链路 | 脚本模拟 | 每个 Phase 交付前 |

---

## 二、Phase 1 测试清单

### 2.1 云函数：articles-write

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| W-01 | 正常写入 10 篇 | 完整 10 篇数据 + 有效 API Key | `{ success: true, inserted: 10 }` | curl POST + 检查响应 |
| W-02 | 缺少 API Key | 无 x-api-key 头 | `{ success: false, error: "Unauthorized" }`, HTTP 401 | curl POST |
| W-03 | 错误 API Key | 无效 key | HTTP 401 | curl POST |
| W-04 | 缺少必填字段 | 某条缺少 title | `{ success: false, error: "..." }`, HTTP 400 | curl POST |
| W-05 | 空 articles 数组 | `{ date: "...", articles: [] }` | HTTP 400, 明确错误信息 | curl POST |
| W-06 | 重复写入（幂等） | 同一日期写入两次 | 第二次覆盖，不产生重复 | 写入两次 → 读取验证数量 |
| W-07 | 字数不足 | content 少于 100 字 | 拒绝或警告 | curl POST |
| W-08 | 无效领域标识 | domain: "X"（不存在） | HTTP 400 | curl POST |

### 2.2 云函数：articles-read

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| R-01 | 获取今日文章 | `?action=today` | 返回今日全部文章 + 领域配置 | curl GET |
| R-02 | 今日无数据 | 当天没有写入 | `{ articles: [], total: 0 }` | curl GET |
| R-03 | 获取往期文章 | `?action=archive&page=1` | 分页返回，按日期倒序 | curl GET |
| R-04 | 领域筛选 | `?action=archive&domain=T` | 只返回技术领域文章 | curl GET |
| R-05 | 获取领域配置 | `?action=domains` | 返回 6 个领域定义 | curl GET |
| R-06 | 分页边界 | `?action=archive&page=999` | 空数组，不报错 | curl GET |
| R-07 | 无效参数 | `?action=invalid` | HTTP 400, 明确错误信息 | curl GET |

### 2.3 Webapp

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| U-01 | 今日 Tab 加载 | 浏览器打开，截图 | 显示当日全部文章，领域标签可见 |
| U-02 | 领域标签筛选 | 点击「技术」标签，截图 | 只显示技术领域文章 |
| U-03 | 往期 Tab | 切换到往期，截图 | 按日期分组显示，默认折叠 |
| U-04 | 往期展开 | 点击某日展开，截图 | 显示该日文章列表 |
| U-05 | 移动端适配 | Chrome DevTools 375px，截图 | 布局正确，文字可读，无横向溢出 |
| U-06 | 暗色模式 | 切换系统暗色模式，截图 | 配色切换，文字清晰可读 |
| U-07 | 原文链接 | 点击原文链接 | 新标签页打开真实 URL |
| U-08 | 空数据状态 | 后端无数据时 | 显示友好空状态提示，不白屏 |
| U-09 | API 加载失败 | 断开 API 连接 | 显示错误提示，不白屏 |
| U-10 | 首屏性能 | Lighthouse 审计 | Performance > 90 |

### 2.4 Pepper 脚本

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| P-01 | 生成 10 篇文章 | 运行脚本，检查输出 | 10 篇，每篇 300-400 字，有 6 个领域 |
| P-02 | 写入 CloudBase | 脚本执行完成后 API 查询 | 数据已入库，字段完整 |
| P-03 | Telegram 通知 | 检查 Telegram 消息 | 收到通知，含 webapp 链接 |
| P-04 | 重复执行（幂等） | 同一天运行两次 | 数据覆盖，不重复 |
| P-05 | RSS 源故障 | 模拟部分 RSS 不可达 | 不崩溃，用可用源凑足内容 |

### 2.5 端到端（E2E）

| 编号 | 测试场景 | 步骤 | 通过标准 |
|------|----------|------|----------|
| E-01 | 完整日更流程 | Pepper 生成 → 写入 API → Webapp 展示 | 全链路通畅，内容一致 |
| E-02 | 从零启动 | 空数据库 → 首次写入 → 首次访问 | Webapp 正常展示，无报错 |
| E-03 | 跨日累积 | 连续两天数据 → 往期页 | 两天数据都在，按日期排列 |

### 2.6 播客日功能（v1.1/v1.2 新增）

#### 2.6.1 云函数：podcast-write

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| PW-01 | 正常写入 8 条播客 | 完整 8 条数据 | `{ success: true, inserted: 8 }` | tcb fn invoke |
| PW-02 | 幂等写入 | 同一日期写入两次 | 第二次覆盖，数量仍为 8 | 写入两次 → 查询验证 |
| PW-03 | 必填字段验证 | 缺少 video_id | 返回错误 | tcb fn invoke |
| PW-04 | intro 字段存储 | 包含 intro 字段 | 数据库中有 intro | 查询数据库验证 |
| PW-05 | key_quotes 双语格式 | `[{en, cn}]` 格式 | 正确存储对象数组 | 查询数据库验证 |

#### 2.6.2 云函数：articles-read（播客相关）

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| PR-01 | 周五今日返回播客 | 周五 `?action=today` | `contentType: "podcast"`, 8 条数据 | curl GET |
| PR-02 | 非周五今日返回文章 | 周一至周四 `?action=today` | `contentType` 不存在，返回 daily_articles | curl GET |
| PR-03 | 播客最新一期 | `?action=podcast-latest` | 返回最新 created_at 的播客组 | curl GET |

#### 2.6.3 Webapp 播客展示

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| PU-01 | 播客卡片布局 | 截图 | 缩略图+标题+频道+时长+摘要 |
| PU-02 | intro 导语显示 | 截图 | 开篇导语在摘要前显示 |
| PU-03 | 嘉宾介绍显示 | 截图 | guest_bio 独立区块，有背景色 |
| PU-04 | 金句双语显示 | 截图 | 英文原话+中文翻译，样式区分 |
| PU-05 | YouTube 链接 | 点击播放按钮 | 新标签页打开正确视频 |
| PU-06 | 移动端适配 | 375px 视口截图 | 卡片正常显示，图片不变形 |

#### 2.6.4 播客内容生成脚本

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| PS-01 | 字幕下载 | 运行脚本 | 8 条均获取字幕（或 fallback） |
| PS-02 | GPT-4o 摘要生成 | 检查输出 | summary_cn 600-800 字，无小标题 |
| PS-03 | intro 生成 | 检查输出 | 80-120 字，含日期+主题 |
| PS-04 | 金句格式 | 检查 JSON | `[{en, cn}]` 格式，2 条 |
| PS-05 | 嘉宾介绍 | 检查输出 | 150-200 字，含背景+代表作 |
| PS-06 | Rate limit 处理 | 模拟限速 | 自动重试，完成全部 8 条 |

### 2.7 短分析格式与 Thumbnail（v1.3 新增）

#### 2.7.1 Thumbnail 抓取脚本

| 编号 | 测试场景 | 输入 | 期望结果 | 验证方式 |
|------|----------|------|----------|----------|
| TH-01 | 单 URL 抓取 | `fetch-og-image.py <url>` | 输出 og:image URL | 运行脚本 |
| TH-02 | 批量处理 | `--batch <json>` | JSON 每条增加 thumbnail 字段 | 检查输出 JSON |
| TH-03 | 无 og:image 的 URL | 无图页面 | 返回空字符串，不报错 | 运行脚本 |
| TH-04 | 超时处理 | 慢速 URL | 15 秒超时，返回空字符串 | 运行脚本 |
| TH-05 | 相对 URL 处理 | og:image 为 `/images/...` | 转为完整 URL | 检查输出 |

#### 2.7.2 短分析内容格式（以 2026-02-04 为基准）

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| DA-01 | summary 字数 | 统计字符 | 300-400 字 |
| DA-02 | detail 字数 | 统计字符 | 500-700 字 |
| DA-03 | signal 字数 | 统计字符 | 100-200 字，"💭 题外话："开头 |
| DA-04 | author_bio 格式 | 检查内容 | 1-3 句，含职位+背景+权威性 |
| DA-05 | 无小标题 | 检查 summary | 不含"核心论点：""关键数据："等标签 |
| DA-06 | 写作调性 | 人工审阅 | 匹配信源风格（FA 严谨/Aeon 思辨） |

#### 2.7.3 Webapp 图文卡片展示

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| TC-01 | 有 thumbnail 时 | 截图 | 文章卡片显示配图 |
| TC-02 | 无 thumbnail 时 | 截图 | graceful fallback，不显示图或显示占位 |
| TC-03 | 图片加载失败 | 模拟 404 | 不影响卡片渲染 |
| TC-04 | 移动端图片适配 | 375px 截图 | 图片宽度自适应，不溢出 |
| PS-06 | Rate limit 处理 | 模拟限速 | 自动重试，完成全部 8 条 |

### 2.7 自动刷新功能（v1.2 新增）

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| AR-01 | 5 分钟定时刷新 | Console 日志 | 每 5 分钟输出 "[Auto-refresh]" 日志 |
| AR-02 | 页面不可见时不刷新 | 切换到其他 Tab | 无刷新请求发出 |
| AR-03 | 页面可见时刷新 | 从其他 Tab 切回 | 立即触发刷新 |
| AR-04 | 有更新时显示 Toast | 数据变化后 | 底部显示"内容已更新"提示 |
| AR-05 | 无更新时静默 | 数据无变化 | 不显示 Toast，用户无感知 |
| AR-06 | 往期页不触发 | 在往期 Tab | 不触发自动刷新 |

---

## 三、Phase 2 测试清单（公众号 + 投票）

### 3.1 综述生成

| 编号 | 测试场景 | 通过标准 |
|------|----------|----------|
| D-01 | 从 10 篇生成综述 | 1500-2500 字，引用 2-3 个主题 |
| D-02 | 投票问题生成 | 映射到有效领域，是/否标签匹配 |
| D-03 | 公众号草稿创建 | 微信后台可见草稿 |

### 3.2 H5 投票

| 编号 | 测试场景 | 通过标准 |
|------|----------|----------|
| V-01 | 投票提交 | 点击后写入数据库，显示结果 |
| V-02 | 防重复投票 | 同一 voter_id 再次投票被拒绝 |
| V-03 | 结果实时更新 | 投票后百分比正确计算 |
| V-04 | 趋势查询 | 90 天趋势数据正确返回 |

---

## 四、测试执行规范

### 4.1 自测流程（每次代码变更后）

```
1. 运行受影响的单元测试
2. curl 测试受影响的 API 端点
3. 浏览器打开 webapp 验证 UI
4. 移动端视口截图验证
5. 暗色模式截图验证（如涉及 UI 变更）
```

### 4.2 交付前流程（每个 Phase 完成时）

```
1. 跑完整测试清单（Phase 对应的全部编号）
2. 每个测试记录：通过/失败 + 证据（截图/curl 输出）
3. 失败项修复后重新验证
4. 全部通过后才向 DQ 报告「完成」
```

### 4.3 回归测试

- 任何 bug 修复必须增加对应测试用例
- 修复后验证：先确认修复前失败（红），再确认修复后通过（绿）

### 4.4 验证纪律（引用 GEMINI.md verification-before-completion）

> **不验证不能声称完成。**
>
> 任何「完成」「修复」「通过」的声明，必须附带：
> 1. 执行的验证命令
> 2. 实际输出/截图
> 3. 输出与期望的对比
>
> 「应该能行」≠ 验证证据。

---

## 五、测试数据

### 5.1 领域测试数据

```json
[
  {"id": "T", "name": "技术", "core_question": "AI 是否正在加剧社会分层？"},
  {"id": "P", "name": "政治", "core_question": "民主制度是否正在失效？"},
  {"id": "H", "name": "历史", "core_question": "当前文明是否正在走向衰退？"},
  {"id": "Φ", "name": "哲学", "core_question": "算法优化是否正在侵蚀自由意志？"},
  {"id": "R", "name": "宗教", "core_question": "科技是否正在成为新宗教？"},
  {"id": "F", "name": "金融", "core_question": "金融是否正在加剧社会撕裂？"}
]
```

### 5.2 文章测试数据

至少准备 10 条完整的测试文章数据，覆盖：
- 6 个领域各至少 1 条
- 含中英文混合内容
- 含特殊字符（引号、破折号、em dash）
- source_url 为真实可访问链接

### 5.3 边界测试数据

- 最短合法文章（300 字）
- 最长合法文章（400 字）
- 超长标题（100 字）
- 含 emoji 的标题
- 含 HTML 标签的 content（应被转义）

---

## 六、已知风险与缓解

| 风险 | 影响 | 缓解 |
|------|------|------|
| CloudBase 云函数冷启动慢 | 首次请求 > 2s | 设置保活策略或接受 |
| 国内网络波动 | API 偶尔超时 | 前端加 loading 状态 + 重试 |
| RSS 源批量不可达 | 当日内容不足 10 篇 | 脚本容错 + 降级提示 |
| Twikoo 评论被滥用 | 垃圾评论 | Akismet 反垃圾 + DQ 审核 |

---

---

## 七、作者验证回归测试（v1.7 新增，02-07 事故后）

**背景**：02-07 首发时 10 篇文章中 9 篇 author 为 "本文来源于[媒体名]"，质检未拦住。

| 编号 | 测试场景 | 验证方式 | 通过标准 |
|------|----------|----------|----------|
| AV-01 | 质检拦截假作者 | `python3 scripts/mot-quality-check.py 2026-02-07` | 包含"本文来源于"的文章被标记为不通过 |
| AV-02 | 禁用词完整性 | 检查 FORBIDDEN_PHRASES 列表 | 包含：本文来源于、来源：、需人工核实、需人工补充 |
| AV-03 | 页面 meta 提取 | `python3 -c "from scripts.mot_content_generator import extract_author_from_url; print(extract_author_from_url('https://www.foreignaffairs.com/...'))"` | 返回真实作者名或 None |
| AV-04 | 生成后全部有真实作者 | 运行 mot-content-generator → 检查 JSON | 0 篇包含"本文来源于" |
| AV-05 | 选题推荐格式 | 运行 mot-daily-workflow → 检查 Telegram 输出 | 包含星级评分(★)和投票问题方向 |

**回归测试命令**：

```bash
# 1. 质检能拦住假作者
python3 scripts/mot-quality-check.py 2026-02-07
# 期望：❌ 不通过，列出 "本文来源于" 的文章

# 2. 检查禁用词列表
python3 -c "
import ast
with open('scripts/mot-quality-check.py') as f:
    src = f.read()
idx = src.index('FORBIDDEN_PHRASES')
end = src.index(']', idx) + 1
phrases = src[idx:end]
print(phrases)
assert '本文来源于' in phrases, 'MISSING: 本文来源于'
assert '来源：' in phrases, 'MISSING: 来源：'
print('✅ 禁用词完整')
"

# 3. 验证 extract_author_from_url 存在
grep -q "def extract_author_from_url" scripts/mot-content-generator.py && echo "✅ 函数存在" || echo "❌ 函数缺失"
```

---

*本文件定义 Mind Our Times 的测试策略和通过标准。*  
*所有测试必须在声称完成前执行并记录证据。*
